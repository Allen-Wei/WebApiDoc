<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>API Documetation</title>
    <link href="http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.css" rel="stylesheet" />
    <script src="../../scripts/jquery-1.8.3.min.js"></script>
    <script src="../../scripts/angular-1.3.15/angular.js"></script>
    <script src="../../scripts/angular-1.3.15/angular-route.js"></script>
    <style type="text/css">
        * { font-family: 'Microsoft YaHei', sans-serif; }
    </style>
</head>
<body>

    <div class="container-fluid" ng-app="ApiDocApp">
        <div class="row">
            <div class="col-sm-12">
                <h3>API Document</h3>
            </div>
        </div>
        <div class="row" ng-controller="BodyCtrl">
            <div class="col-sm-3" ng-controller="NavigationCtrl">
                <ul class="list-group">
                    <li class="list-group-item" ng-repeat="nav in navigations">
                        <a href="{{nav.path}}">{{nav.name}}</a>
                    </li>
                </ul>
            </div>
            <div class="col-sm-9">
                <div ng-view></div>
            </div>
        </div>
    </div>


    <script>
        var app = angular.module('ApiDocApp', ['ngRoute']);

        app.factory('ApiQuerySvc', function ($http) {

            var service = {
                getStatus: function () {
                    return $http({
                        method: 'get',
                        url: '/Api/ApiDocumentation?action=status'
                    });
                },
                getControllers: function () {
                    return $http({
                        method: 'Get',
                        url: '/Api/ApiDocumentation?action=controllers'
                    });
                },
                getAll: function () {
                    return $http({
                        method: 'get',
                        url: '/Api/ApiDocumentation'
                    });
                },
                getApisByController: function (apiId) {
                    return $http({
                        method: 'get',
                        url: '/Api/ApiDocumentation/' + apiId
                    });
                }
            };
            return service;
        });
        app.config(function ($routeProvider) {
            $routeProvider.when('/guid', {
                controller: 'GuidCtrl',
                templateUrl: './partial/guid.html'
            }).when('/status', {
                controller: 'StatausCodeCtrl',
                templateUrl: './partial/status.html'
            }).when('/api/:id', {
                controller: 'ApiDetailCtrl',
                templateUrl: './partial/apidetail.html'
            }).otherwise({
                redirectTo: '/guid'
            });
        });

        app.controller('BodyCtrl', function ($scope, $http, ApiQuerySvc) {

            $scope.main = {
                apis: []
            };

            ApiQuerySvc.getControllers();
        });

        app.controller('NavigationCtrl', function ($scope, ApiQuerySvc) {
            $scope.navigations = [{
                name: 'API使用和设计规范',
                path: '#/guid'
            }, {
                name: '返回结果描述',
                path: '#/status'
            }];

            ApiQuerySvc.getControllers().then(function (rep) {
                var controllers = rep.data;
                for (var i = 0; i < controllers.length; i++) {
                    $scope.navigations.push({
                        name: controllers[i],
                        path: '#/api/' + controllers[i]
                    });
                }
            });
        });
        app.controller('GuidCtrl', function ($scope) {

        });
        app.controller('StatausCodeCtrl', function ($scope, $http, ApiQuerySvc) {
            $scope.main = {
                list: [],
                refresh: function () {
                    ApiQuerySvc.getStatus().then(function (rep) {
                        var result = rep.data;
                        $scope.main.list = result;
                    });
                }
            };

            $scope.main.refresh();
        });

        app.controller('ApiDetailCtrl', function ($scope, ApiQuerySvc, $routeParams, $http) {
            $scope.main = {
                apis: [],
                controller: {},
                apiTest: {
                    urlParams: '',
                    body: '',
                    result: '',
                    selectedIndex: 0,
                    selected: function () {
                        return $scope.main.apis[this.selectedIndex];
                    },
                    send: function () {
                        var scope = this;

                        var api = scope.selected();
                        if (!api) {
                            alert('接口选择错误');
                            return;
                        }

                        var url = api.RelativePath || '';
                        //替换URL参数
                        if (scope.urlParams) {
                            var params = scope.urlParams;
                            params = params.split('&');
                            for (var i = 0; i < params.length; i++) {
                                var para = params[i];
                                var placeholder = '{' + para.split('=')[0] + '}';
                                var value = para.split('=')[1];
                                url = url.replace(placeholder, value);
                            }
                        }

                        var bodyData = undefined;
                        try {
                            if (scope.body) {
                                bodyData = JSON.parse(scope.body);
                            }
                        } catch (ex) {
                            alert('Body不是有效的JSON数据.(JSON的Key和类型为字符串的Value必须有双引号包裹)', ex.message);
                            return;
                        }

                        console.log('Request Information: ');
                        console.log('Url: ', url);
                        console.log('Method: ', api.HttpMethod);
                        console.log('Body', bodyData);

                        $http({
                            method: api.HttpMethod,
                            url: '/' + url,
                            data: bodyData
                        }).then(function (rep) {
                            scope.result = JSON.stringify(rep.data, null, 2);
                        });
                    }
                }
            };
            var controllerName = $routeParams.id;
            ApiQuerySvc.getApisByController(controllerName).then(function (rep) {
                $scope.main.apis = rep.data.apis;
                $scope.main.controller = rep.data.controller;
            });
        });

        /*
        * ApiInformation: apiUrl, parameters:[{name:'', type:'', description:'', attention:'', note:'', example:''}], example:''
        */

        $('body').on('toggle', '.slide-toggle', function () {
            if ($(this).is('.glyphicon-chevron-up')) {
                $(this).removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down').closest('.panel').find('.api-collapse').show();
            } else {
                $(this).removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up').closest('.panel').find('.api-collapse').hide();
            }
        }).on('click', '.btn-toggle', function () {
            //收起或折叠Panel
            var status = $(this).data('slide-status') || 'down';
            $('.glyphicon-chevron-' + status).trigger('click');
            $(this).data('slide-status', (status == 'down' ? 'up' : 'down'));
        }).on('click', '.panel-heading', function () {
            $(this).find('.slide-toggle').trigger('toggle');
        });
    </script>

</body>
</html>
